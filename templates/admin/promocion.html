<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Productos en Promoción</title>
    <style>
        table { border-collapse: collapse; width: 60%; margin: 20px auto; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        select, input[type="number"] { width: 90%; }
        .center { text-align: center; }
    </style>
</head>
<body>
    <h2 class="center">Gestión de Productos en Promoción</h2>
    <h3 class="center" style="margin-bottom: 10px; color: #2d6a4f;">Lista de productos en promoción</h3>
    <form method="post">
        <table class="admin-table">
            <thead>
                <tr>
                    <th style="width: 10%">ID</th>
                    <th style="width: 30%">Nombre</th>
                    <th style="width: 15%">Precio</th>
                    <th style="width: 15%">Descuento (%)</th>
                    <th style="width: 20%">Precio con Descuento</th>
                    <th style="width: 10%">Acciones</th>
                </tr>
            </thead>
            <tbody id="tbody-promos">
                {% if promociones %}
                    {% for promo in promociones %}
                    <tr>
                        <td><input type="number" name="producto[]" class="input-id" value="{{ promo.producto_id }}" min="1" required style="width: 90%"></td>
                        <td><input type="text" name="nombre[]" class="input-nombre" value="{{ promo.nombre }}" readonly style="width: 98%"></td>
                        <td><input type="number" name="precio[]" class="input-precio" step="0.01" min="0" value="{{ promo.precio }}" readonly style="width: 90%"></td>
                        <td><input type="number" name="descuento[]" class="input-descuento" min="0" max="100" value="{{ promo.descuento }}" style="width: 80%"></td>
                        <td><input type="number" name="precio_descuento[]" class="input-precio-descuento" step="0.01" min="0" value="{{ promo.precio_descuento }}" readonly style="width: 90%"></td>
                        <td><button type="button" class="button small danger" onclick="eliminarFila(this)">Eliminar</button></td>
                    </tr>
                    {% endfor %}
                {% else %}
                <tr>
                    <td><input type="number" name="producto[]" class="input-id" min="1" required style="width: 90%"></td>
                    <td><input type="text" name="nombre[]" class="input-nombre" readonly style="width: 98%"></td>
                    <td><input type="number" name="precio[]" class="input-precio" step="0.01" min="0" readonly style="width: 90%"></td>
                    <td><input type="number" name="descuento[]" class="input-descuento" min="0" max="100" value="0" style="width: 80%"></td>
                    <td><input type="number" name="precio_descuento[]" class="input-precio-descuento" step="0.01" min="0" readonly style="width: 90%"></td>
                    <td><button type="button" class="button small danger" onclick="eliminarFila(this)">Eliminar</button></td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        <div class="center">
            <button type="button" onclick="agregarFila()">Agregar Producto</button>
            <button type="submit">Aplicar Promociones</button>
        </div>
    </form>
    <script>
        // Datos de productos para búsqueda JS
        const productos = {{ productos_js|tojson }};

        function actualizarEventos() {
            document.querySelectorAll('.input-id').forEach(function(input) {
                input.oninput = function() {
                    var fila = input.closest('tr');
                    var prod = productos.find(p => p.id == input.value);
                    if (prod) {
                        fila.querySelector('.input-nombre').value = prod.nombre;
                        fila.querySelector('.input-precio').value = prod.precio;
                    } else {
                        fila.querySelector('.input-nombre').value = '';
                        fila.querySelector('.input-precio').value = '';
                    }
                    actualizarPrecioDescuento(fila);
                };
            });
            document.querySelectorAll('.input-descuento').forEach(function(input) {
                input.oninput = function() {
                    var fila = input.closest('tr');
                    actualizarPrecioDescuento(fila);
                };
            });
        }
        function actualizarPrecioDescuento(fila) {
            var precio = parseFloat(fila.querySelector('.input-precio').value) || 0;
            var descuento = parseFloat(fila.querySelector('.input-descuento').value) || 0;
            var precio_desc = precio - (precio * descuento / 100);
            fila.querySelector('.input-precio-descuento').value = precio_desc.toFixed(2);
        }
        function eliminarFila(boton) {
            var fila = boton.closest('tr');
            fila.remove();
        }
        function agregarFila() {
            var tabla = document.getElementById('tbody-promos');
            var nuevaFila = document.createElement('tr');
            nuevaFila.innerHTML = `
                <td><input type="number" name="producto[]" class="input-id" min="1" required></td>
                <td><input type="text" name="nombre[]" class="input-nombre" readonly></td>
                <td><input type="number" name="precio[]" class="input-precio" step="0.01" min="0" readonly></td>
                <td><input type="number" name="descuento[]" class="input-descuento" min="0" max="100" value="0"></td>
                <td><input type="number" name="precio_descuento[]" class="input-precio-descuento" step="0.01" min="0" readonly></td>
                <td><button type="button" onclick="eliminarFila(this)">Eliminar</button></td>
            `;
            tabla.appendChild(nuevaFila);
            actualizarEventos();
        }
        actualizarEventos();
    </script>
</body>
</html>